<?xml version="1.0" encoding="UTF-8"?>
<!--
    Copyright (c) 2017-present Sonatype, Inc.
    All rights reserved. Includes the third-party code listed at http://links.sonatype.com/products/nexus/pro/attributions
    Sonatype and Sonatype Nexus are trademarks of Sonatype, Inc. Apache Maven is a trademark of the Apache Foundation.
    M2Eclipse is a trademark of the Eclipse Foundation. All other trademarks are the property of their respective owners.
-->
<hazelcast xmlns="http://www.hazelcast.com/schema/config"
           xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
           xsi:schemaLocation="http://www.hazelcast.com/schema/config hazelcast-config-3.6.xsd">
  <group>
    <name><%= node['nexus_repository_manager']['hazelcast']['group']['name'] %></name>
    <password><%= node['nexus_repository_manager']['hazelcast']['group']['password'] %></password>
  </group>

  <management-center enabled="true">http://localhost:8080/</management-center>

  <properties>
    <property name="hazelcast.shutdownhook.enabled">false</property>
    <property name="hazelcast.logging.type">slf4j</property>
    <property name="hazelcast.jmx">true</property>
    <!--<property name="hazelcast.jmx.detailed">false</property>-->
    <property name="hazelcast.phone.home.enabled">false</property>
    <property name="hazelcast.prefer.ipv4.stack">true</property>
    <property name="hazelcast.health.monitoring.level">SILENT</property>

    <!-- OrientDB: use low number of threads -->
    <property name="hazelcast.operation.thread.count">1</property>
    <property name="hazelcast.operation.generic.thread.count">1</property>
    <property name="hazelcast.client.event.thread.count">1</property>
    <property name="hazelcast.event.thread.count">1</property>

    <!-- OrientDB: reduce split-brain check interval -->
    <property name="hazelcast.max.no.heartbeat.seconds">30</property>
    <property name="hazelcast.heartbeat.interval.seconds">5</property>

    <!-- OrientDB: reduce split-brain merge interval -->
    <property name="hazelcast.merge.next.run.delay.seconds">15</property>

    <!-- OrientDB: use ICMP to detect crashed nodes -->
    <property name="hazelcast.icmp.enabled">true</property>
    <property name="hazelcast.icmp.timeout">5000</property>
    <property name="hazelcast.icmp.ttl">3</property>

    <property name="hazelcast.discovery.enabled"><%= node['nexus_repository_manager']['hazelcast']['discovery']['enabled'] %></property>
  </properties>

  <network>
    <port auto-increment="true" port-count="100">5701</port>

    <outbound-ports>
      <!--
          Allowed port range when connecting to other nodes.
          0 or * means use system provided port.
      -->
      <ports>0</ports>
    </outbound-ports>

    <join>
      <multicast enabled="<%= node['nexus_repository_manager']['hazelcast']['multicast']['enabled'] %>">
        <multicast-group><%= node['nexus_repository_manager']['hazelcast']['multicast']['group'] %></multicast-group>
        <multicast-port><%= node['nexus_repository_manager']['hazelcast']['multicast']['port'] %></multicast-port>
      </multicast>
      <tcp-ip enabled="<%= node['nexus_repository_manager']['hazelcast']['tcp_ip']['enabled'] %>">
        <interface><%= node['nexus_repository_manager']['hazelcast']['tcp_ip']['interface'] %></interface>
        <member-list>
          <% node['nexus_repository_manager']['hazelcast']['tcp_ip']['members'].each do |ip| %>
          <member><%= "#{ip}" %></member>
          <% end %>
        </member-list>
      </tcp-ip>
      <aws enabled="<%= node['nexus_repository_manager']['hazelcast']['aws']['enabled'] %>">
        <iam-role><%= node['nexus_repository_manager']['hazelcast']['aws']['iam_role'] %></iam-role>
        <!--optional, default is us-east-1 -->
        <region><%= node['nexus_repository_manager']['hazelcast']['aws']['region'] %></region>
        <!--optional, default is ec2.amazonaws.com. If set, region shouldn't be set as it will override this property -->
        <host-header>ec2.amazonaws.com</host-header>
        <!-- optional, only instances belonging to this group will be discovered, default will try all running instances -->
        <!-- <security-group-name>hazelcast-sg</security-group-name> -->
        <tag-key><%= node['nexus_repository_manager']['hazelcast']['aws']['tag_key'] %></tag-key>
        <tag-value><%= node['nexus_repository_manager']['hazelcast']['aws']['tag_value'] %></tag-value>
      </aws>
      <discovery-strategies>
          <% if node['nexus_repository_manager']['hazelcast']['discovery']['enabled'] %>
          <!-- class equals to the DiscoveryStrategy not the factory! -->
          <discovery-strategy enabled="<%= node['nexus_repository_manager']['hazelcast']['discovery']['enabled'] %>" class="com.hazelcast.aws.AwsDiscoveryStrategy">
              <properties>
                 <property name="iam-role"><%= node['nexus_repository_manager']['hazelcast']['discovery']['iam_role'] %></property>
                 <property name="region"><%= node['nexus_repository_manager']['hazelcast']['discovery']['region'] %></property>
                 <property name="host-header">ec2.amazonaws.com</property>
                 <% if node['nexus_repository_manager']['hazelcast']['discovery']['security_group_name'] != '' %>
                 <property name="security-group-name"><%= node['nexus_repository_manager']['hazelcast']['discovery']['security_group_name'] %></property>
                 <% end %>
                 <property name="tag-key"><%= node['nexus_repository_manager']['hazelcast']['discovery']['tag_key'] %></property>
                 <property name="tag-value"><%= node['nexus_repository_manager']['hazelcast']['discovery']['tag_value'] %></property>
                 <property name="hz-port"><%= node['nexus_repository_manager']['hazelcast']['discovery']['hz_port'] %></property>
              </properties>
          </discovery-strategy>
          <% end %>
      </discovery-strategies>
    </join>

    <interfaces enabled="false">
      <interface>10.10.1.*</interface>
    </interfaces>

    <ssl enabled="false"/>

    <socket-interceptor enabled="false"/>

    <symmetric-encryption enabled="false">
      <!--
         encryption algorithm such as
         DES/ECB/PKCS5Padding,
         PBEWithMD5AndDES,
         AES/CBC/PKCS5Padding,
         Blowfish,
         DESede
      -->
      <algorithm>PBEWithMD5AndDES</algorithm>
      <!-- salt value to use when generating the secret key -->
      <salt>thesalt</salt>
      <!-- pass phrase to use when generating the secret key -->
      <password>thepass</password>
      <!-- iteration count to use when generating the secret key -->
      <iteration-count>19</iteration-count>
    </symmetric-encryption>
  </network>

  <partition-group enabled="false"/>

  <executor-service name="default">
    <pool-size>16</pool-size>
    <!-- Queue capacity. 0 means Integer.MAX_VALUE -->
    <queue-capacity>0</queue-capacity>
  </executor-service>

  <queue name="default">
    <!--
        Maximum size of the queue. When a JVM's local queue size reaches the maximum,
        all put/offer operations will get blocked until the queue size
        of the JVM goes down below the maximum.
        Any integer between 0 and Integer.MAX_VALUE. 0 means
        Integer.MAX_VALUE. Default is 0.
    -->
    <max-size>0</max-size>
    <!--
        Number of backups. If 1 is set as the backup-count for example,
        then all entries of the map will be copied to another JVM for
        fail-safety. 0 means no backup.
    -->
    <backup-count>1</backup-count>
    <!--
        Number of async backups. 0 means no backup.
    -->
    <async-backup-count>0</async-backup-count>
    <empty-queue-ttl>-1</empty-queue-ttl>
  </queue>

  <map name="default">
    <!--
        Data type that will be used for storing recordMap.
        Possible values:
            BINARY (default): keys and values will be stored as binary data
            OBJECT : values will be stored in their object forms
            NATIVE : values will be stored in non-heap region of JVM
    -->
    <in-memory-format>BINARY</in-memory-format>
    <!--
        Number of backups. If 1 is set as the backup-count for example,
        then all entries of the map will be copied to another JVM for
        fail-safety. 0 means no backup.
    -->
    <backup-count>1</backup-count>
    <!--
        Number of async backups. 0 means no backup.
    -->
    <async-backup-count>0</async-backup-count>
    <!--
        Maximum number of seconds for each entry to stay in the map. Entries that are
        older than <time-to-live-seconds> and not updated for <time-to-live-seconds>
        will get automatically evicted from the map.
        Any integer between 0 and Integer.MAX_VALUE. 0 means infinite. Default is 0.
    -->
    <time-to-live-seconds>0</time-to-live-seconds>
    <!--
        Maximum number of seconds for each entry to stay idle in the map. Entries that are
        idle(not touched) for more than <max-idle-seconds> will get
        automatically evicted from the map. Entry is touched if get, put or containsKey is called.
        Any integer between 0 and Integer.MAX_VALUE. 0 means infinite. Default is 0.
    -->
    <max-idle-seconds>0</max-idle-seconds>
    <!--
        Valid values are:
        NONE (no eviction),
        LRU (Least Recently Used),
        LFU (Least Frequently Used).
        NONE is the default.
    -->
    <eviction-policy>NONE</eviction-policy>
    <!--
        Maximum size of the map. When max size is reached,
        map is evicted based on the policy defined.
        Any integer between 0 and Integer.MAX_VALUE. 0 means
        Integer.MAX_VALUE. Default is 0.
    -->
    <max-size policy="PER_NODE">0</max-size>
    <!--
        When max. size is reached, specified percentage of
        the map will be evicted. Any integer between 0 and 100.
        If 25 is set for example, 25% of the entries will
        get evicted.
    -->
    <eviction-percentage>25</eviction-percentage>
    <!--
        Minimum time in milliseconds which should pass before checking
        if a partition of this map is evictable or not.
        Default value is 100 millis.
    -->
    <min-eviction-check-millis>100</min-eviction-check-millis>
    <!--
        While recovering from split-brain (network partitioning),
        map entries in the small cluster will merge into the bigger cluster
        based on the policy set here. When an entry merge into the
        cluster, there might an existing entry with the same key already.
        Values of these entries might be different for that same key.
        Which value should be set for the key? Conflict is resolved by
        the policy set here. Default policy is PutIfAbsentMapMergePolicy

        There are built-in merge policies such as
        com.hazelcast.map.merge.PassThroughMergePolicy; entry will be overwritten if merging entry exists for the key.
        com.hazelcast.map.merge.PutIfAbsentMapMergePolicy ; entry will be added if the merging entry doesn't exist in the cluster.
        com.hazelcast.map.merge.HigherHitsMapMergePolicy ; entry with the higher hits wins.
        com.hazelcast.map.merge.LatestUpdateMapMergePolicy ; entry with the latest update wins.
    -->
    <merge-policy>com.hazelcast.map.merge.PutIfAbsentMapMergePolicy</merge-policy>
    <!--
        Control caching of de-serialized values. Caching makes query evaluation faster, but it cost memory.
        Possible Values:
            NEVER: Never cache deserialized object
            INDEX-ONLY: Caches values only when they are inserted into an index.
            ALWAYS: Always cache deserialized values.
    -->
    <cache-deserialized-values>INDEX-ONLY</cache-deserialized-values>
  </map>

  <multimap name="default">
    <backup-count>1</backup-count>
    <value-collection-type>SET</value-collection-type>
  </multimap>

  <list name="default">
    <backup-count>1</backup-count>
  </list>

  <set name="default">
    <backup-count>1</backup-count>
  </set>

  <jobtracker name="default">
    <max-thread-size>0</max-thread-size>
    <!-- Queue size 0 means number of partitions * 2 -->
    <queue-size>0</queue-size>
    <retry-count>0</retry-count>
    <chunk-size>1000</chunk-size>
    <communicate-stats>true</communicate-stats>
    <topology-changed-strategy>CANCEL_RUNNING_OPERATION</topology-changed-strategy>
  </jobtracker>

  <semaphore name="default">
    <initial-permits>0</initial-permits>
    <backup-count>1</backup-count>
    <async-backup-count>0</async-backup-count>
  </semaphore>

  <reliable-topic name="default">
    <read-batch-size>10</read-batch-size>
    <topic-overload-policy>BLOCK</topic-overload-policy>
    <statistics-enabled>true</statistics-enabled>
  </reliable-topic>

  <ringbuffer name="default">
    <capacity>10000</capacity>
    <backup-count>1</backup-count>
    <async-backup-count>0</async-backup-count>
    <time-to-live-seconds>30</time-to-live-seconds>
    <in-memory-format>BINARY</in-memory-format>
  </ringbuffer>

  <serialization>
    <portable-version>0</portable-version>
  </serialization>

  <services enable-defaults="true"/>
</hazelcast>
